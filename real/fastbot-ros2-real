# Start from ROS base image
FROM arm64v8/ros:humble

# Make workspace
RUN mkdir -p /ros2_ws/src
WORKDIR /ros2_ws/src

RUN apt-get update && apt-get install -y \
    ros-humble-xacro \
    ros-humble-robot-state-publisher \
    ros-humble-v4l2-camera \
    ros-humble-diagnostic-updater \
    ros-humble-pcl-conversions \
    python3-colcon-common-extensions \
    python3-serial \
    libboost-all-dev \
    libpcl-dev \
    libpcap-dev \
	ros-humble-rmw-cyclonedds-cpp \
    && rm -rf /var/lib/apt/lists/*

# Copy WHOLE setup here
COPY ./src ./ros2_ws/src
COPY cyclonedds_husarnet.xml /var/lib/theconstruct.rrl/cyclonedds_husarnet.xml

# Build workspace
RUN /bin/bash -c "source /opt/ros/humble/setup.bash && cd /ros2_ws && colcon build"

# Optional: if you use these from RRL, add them too:
ENV ROS_DOMAIN_ID=0
ENV RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
ENV CYCLONEDDS_URI=file:///var/lib/theconstruct.rrl/cyclonedds_husarnet.xml

# Source ROS2 setup file
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
# Source workspace setup file
RUN echo "source /ros2_ws/install/setup.bash" >> ~/.bashrc

# ENTRYPOINT: keep launch in foreground, no '&'
ENTRYPOINT ["/bin/bash", "-c", "source /opt/ros/humble/setup.bash && source /ros2_ws/install/setup.bash && ros2 launch fastbot_bringup bringup.launch.xml"]